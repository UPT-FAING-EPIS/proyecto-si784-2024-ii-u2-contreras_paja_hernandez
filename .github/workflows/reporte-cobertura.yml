name: Pruebas y Publicaci√≥n en GitHub Pages

on: 
  push:
    branches: 
      - main  
  pull_request:
    branches: 
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: '8.0.x'

    - name: Ejecutar pruebas y recolectar cobertura y mutaciones
      run: |
        cd ProyectoAsistencia/ProyectoAsistencia.Tests  
        dotnet test --collect:"XPlat Code Coverage"

        dotnet tool install -g dotnet-reportgenerator-globaltool
        reportgenerator "-reports:TestResults/**/coverage.cobertura.xml" "-targetdir:Reports/Cobertura" -reporttypes:HTML

        dotnet tool install -g dotnet-stryker
        dotnet stryker
      continue-on-error: true

    - name: Mover a carpeta
      run: |
        cd ProyectoAsistencia/ProyectoAsistencia.Tests
  
        # Copiar reporte de mutaciones
        mkdir -p ../../ReportesGH
        if [ -d "StrykerOutput" ]; then
          latest_folder=$(ls -td StrykerOutput/* | head -n 1)
          cp "$latest_folder/reports/mutation-report.html" ../../ReportesGH/ || echo "No Stryker report found"
        fi

         # Copiar reporte de cobertura
         cp Reports/Cobertura/index.html ../../ReportesGH/ || echo "No coverage report found"
    - name: Verificar contenido de ReportesGH
      run: |
        ls -R ReportesGH || echo "ReportesGH is empty"

    - name: Publicar reportes en GitHub Pages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"

        # Preparar rama gh-pages
        git fetch origin
        git checkout -B gh-pages origin/gh-pages || git checkout -B gh-pages
        git rm -rf ./*
        cp -r ../ReportesGH/* . || echo "No files to copy"
        git add .

        # Confirmar cambios solo si hay archivos nuevos
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "Actualizar reportes de pruebas y mutaciones"
          git push origin gh-pages --force
        else
          echo "No hay cambios que publicar."
        fi
